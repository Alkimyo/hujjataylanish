<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hujjat tekshirish - UniDoc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .verify-container { max-width: 450px; margin: 0 auto; width: 100%; }
        .card { border-radius: 20px; box-shadow: 0 18px 40px rgba(0,0,0,0.2); border: none; }
        .verification-code-input {
            font-size: 2.5rem; text-align: center; letter-spacing: 8px;
            font-weight: 800; text-transform: uppercase; padding: 15px;
            border: 2px solid #e2e8f0; border-radius: 12px;
            background-color: #f8fafc; color: #2d3748;
        }
        .verification-code-input:focus {
            border-color: #667eea; outline: none; background-color: #fff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .verify-result {
            border-radius: 14px;
            padding: 12px 14px;
            margin-top: 16px;
            display: none;
        }

        .verify-result.success {
            background: #e7f7ef;
            color: #0f5132;
            border: 1px solid rgba(25, 135, 84, 0.25);
        }

        .verify-result.error {
            background: #fdecea;
            color: #842029;
            border: 1px solid rgba(220, 53, 69, 0.25);
        }

        .verify-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .verify-chip {
            font-size: 0.78rem;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(102, 126, 234, 0.12);
            color: #2d3748;
        }

        .verify-guide {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 16px;
            padding: 14px 16px;
            color: #f8f9ff;
            font-size: 0.9rem;
        }

        .verify-guide h6 {
            font-weight: 700;
            margin-bottom: 8px;
        }

        .verify-guide ul {
            margin: 0;
            padding-left: 18px;
        }

        .verify-guide li {
            margin-bottom: 6px;
        }

        .verify-tip {
            font-size: 0.78rem;
            color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body>
    <div class="container p-3">
        <div class="verify-container">
            
            <div class="text-center mb-4">
                <h2 class="text-white fw-bold"><i class="bi bi-shield-check"></i> UniDoc</h2>
                <p class="text-white-50">Hujjat kodini kiriting</p>
            </div>
            
            <div class="card p-4">
                {% if error %}
                <div class="alert alert-danger d-flex align-items-center animate__animated animate__shakeX">
                    <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
                    <div><strong>Xatolik:</strong> {{ error }}</div>
                </div>
                {% endif %}

                <form method="POST" id="verifyForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <input type="text" name="verification_code" 
                               id="codeInput"
                               class="form-control verification-code-input" 
                               placeholder="____"
                               maxlength="4"
                               autocomplete="off"
                               required>
                        <div class="text-center text-muted small mt-2">
                            4 xonali kodni kiriting
                        </div>
                    </div>

                </form>

                <div id="statusText" class="text-center text-primary fw-bold" style="display: none;">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Qidirilmoqda...
                </div>

                <div id="qrError" class="text-center text-danger small mt-3" style="display: none;"></div>
                <div id="verifyResult" class="verify-result">
                    <div id="verifyTitle" class="fw-semibold"></div>
                    <div id="verifyExists" class="small mt-1"></div>
                    <div class="verify-meta">
                        <span id="verifyStatus" class="verify-chip"></span>
                        <span id="verifyType" class="verify-chip"></span>
                    </div>
                    <a id="verifyDownload" class="btn btn-sm btn-primary mt-3 d-none" target="_blank" rel="noopener">
                        <i class="bi bi-download"></i> Yuklab olish
                    </a>
                </div>
            </div>

            <div class="verify-guide mt-3">
                <h6><i class="bi bi-info-circle"></i> Tekshirish qo‘llanmasi</h6>
                <ul>
                    <li>Hujjatdagi 4 xonali kodni kiriting.</li>
                    <li>Kod to‘g‘ri bo‘lsa, hujjat mavjudligi chiqadi.</li>
                    <li>Yuklab olish tugmasi chiqsa, tasdiqlang va faylni oling.</li>
                </ul>
                <div class="verify-tip mt-2">Maslahat: kodni hujjatning oxirgi sahifasidan topasiz.</div>
            </div>

            <div class="text-center mt-4">
                <a href="/" class="text-white-50 text-decoration-none small">
                    <i class="bi bi-arrow-left"></i> Bosh sahifaga qaytish
                </a>
            </div>
        </div>
    </div>
    
    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('codeInput');
            const form = document.getElementById('verifyForm');
            const statusText = document.getElementById('statusText');
            const qrError = document.getElementById('qrError');
            const verifyResult = document.getElementById('verifyResult');
            const verifyTitle = document.getElementById('verifyTitle');
            const verifyExists = document.getElementById('verifyExists');
            const verifyStatus = document.getElementById('verifyStatus');
            const verifyType = document.getElementById('verifyType');
            const verifyDownload = document.getElementById('verifyDownload');
            if (input) {
                input.focus(); // Avtomatik fokus

                input.addEventListener('input', function(e) {
                    // Faqat harf va raqam, katta harfga o'tkazish
                    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    e.target.value = value;

                    // 4 ta belgi bo'lganda
                    if (value.length === 4) {
                        checkByCode(value);
                    }
                });
            }

            function showResultSuccess(payload) {
                if (!verifyResult) return;
                verifyResult.classList.remove('error');
                verifyResult.classList.add('success');
                verifyResult.style.display = 'block';
                verifyTitle.textContent = payload.title || 'Hujjat mavjud';
                verifyExists.textContent = 'Hujjat mavjud.';
                verifyStatus.textContent = payload.status || 'Tasdiqlangan';
                verifyType.textContent = payload.type || 'Hujjat';
                if (payload.file_url) {
                    verifyDownload.href = payload.file_url;
                    verifyDownload.classList.remove('d-none');
                } else {
                    verifyDownload.classList.add('d-none');
                }
            }

            function showResultError(message) {
                if (!verifyResult) return;
                verifyResult.classList.remove('success');
                verifyResult.classList.add('error');
                verifyResult.style.display = 'block';
                verifyTitle.textContent = message || 'Hujjat topilmadi';
                verifyExists.textContent = '';
                verifyStatus.textContent = '';
                verifyType.textContent = '';
                verifyDownload.classList.add('d-none');
            }

            function setLoading(isLoading) {
                statusText.style.display = isLoading ? 'block' : 'none';
            }

            function showQrError(message) {
                if (!qrError) return;
                qrError.textContent = message;
                qrError.style.display = 'block';
            }

            function clearQrError() {
                if (!qrError) return;
                qrError.textContent = '';
                qrError.style.display = 'none';
            }

            function checkByCode(code) {
                clearQrError();
                setLoading(true);
                fetch(`/verify/?check=1&code=${encodeURIComponent(code)}`)
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (ok && data.exists) {
                            showResultSuccess(data);
                        } else {
                            showResultError(data.error || 'Hujjat topilmadi.');
                        }
                    })
                    .catch(() => showResultError('Serverga ulanib bo‘lmadi.'))
                    .finally(() => setLoading(false));
            }
            if (verifyDownload) {
                verifyDownload.addEventListener('click', (event) => {
                    const ok = window.confirm('Hujjatni yuklab olishni xohlaysizmi?');
                    if (!ok) {
                        event.preventDefault();
                    }
                });
            }
        });
    </script>
</body>
</html>
